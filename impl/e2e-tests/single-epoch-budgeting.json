{
  "events": [
    {
      "seconds": 1,
      "site": "publisher.example",
      "event": "saveImpression",
      "options": { "histogramIndex": 0 }
    },
    {
      "seconds": 2,
      "site": "publisher.example",
      "event": "saveImpression",
      "options": { "histogramIndex": 1 }
    },
    {
      "seconds": 3,
      "site": "advertiser-1.example",
      "event": "measureConversion",
      "options": {
        "aggregationService": "https://agg-service.example",
        "epsilon": 1,
        "histogramSize": 3,
        "lookbackDays": 1,
        "value": 4,
        "maxValue": 8,
        "credit": [3, 1]
      },
      "$comment": "Consumes 1/4 of budget: sensitivity=l1Norm=1+3=4; noiseScale=(2*maxValue)/epsilon=16; deductionFp=sensitivity/noiseScale=1/4",
      "expected": [1, 3, 0]
    },
    {
      "seconds": 4,
      "site": "advertiser-1.example",
      "event": "measureConversion",
      "options": {
        "aggregationService": "https://agg-service.example",
        "epsilon": 1,
        "histogramSize": 3,
        "lookbackDays": 1,
        "value": 8,
        "maxValue": 8,
        "credit": [1]
      },
      "$comment": "Consumes 1/2 of budget: sensitivity=l1Norm=8; noiseScale=(2*maxValue)/epsilon=16; deductionFp=sensitivity/noiseScale=1/2",
      "expected": [0, 8, 0]
    },
    {
      "seconds": 5,
      "site": "advertiser-1.example",
      "event": "measureConversion",
      "options": {
        "aggregationService": "https://agg-service.example",
        "epsilon": 1,
        "histogramSize": 3,
        "lookbackDays": 1,
        "value": 8,
        "maxValue": 8,
        "credit": [1]
      },
      "$comment": "The histogram is [0, 8, 0] as in the preceding case, but ends up being zeroed because only 1/4 of the budget remains, not the 1/2 required",
      "expected": [0, 0, 0]
    },
    {
      "seconds": 6,
      "site": "advertiser-1.example",
      "event": "measureConversion",
      "options": {
        "aggregationService": "https://agg-service.example",
        "epsilon": 1,
        "histogramSize": 3,
        "lookbackDays": 1,
        "value": 4,
        "maxValue": 8,
        "credit": [3, 1]
      },
      "$comment": "The preceding case should have subtracted the remaining 1/4 even though it was insufficient for the 1/2 required",
      "expected": [0, 0, 0]
    },
    {
      "seconds": 7,
      "site": "advertiser-2.example",
      "event": "measureConversion",
      "options": {
        "aggregationService": "https://agg-service.example",
        "epsilon": 1,
        "histogramSize": 3,
        "lookbackDays": 1,
        "value": 4,
        "maxValue": 8,
        "credit": [3, 1]
      },
      "$comment": "Separate sites have separate budgets",
      "expected": [1, 3, 0]
    },
    {
      "$comment": "The epoch start is set to 0.5 so the minimum time for this impression to be associated with a new epoch is 7*0.5=3.5 days from the first conversion attempt",
      "seconds": 302403,
      "site": "publisher.example",
      "event": "saveImpression",
      "options": { "histogramIndex": 2 }
    },
    {
      "seconds": 302404,
      "site": "advertiser-1.example",
      "event": "measureConversion",
      "options": {
        "aggregationService": "https://agg-service.example",
        "epsilon": 1,
        "histogramSize": 3,
        "lookbackDays": 1,
        "value": 4,
        "maxValue": 8,
        "credit": [1]
      },
      "$comment": "The site has fresh budget in the new epoch",
      "expected": [0, 0, 4]
    }
  ]
}
